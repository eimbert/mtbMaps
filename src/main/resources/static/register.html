<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro - PayGoon</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; max-width: 640px; padding: 24px; background: #f7f7f7; }
        h1 { color: #0b4f6c; }
        form { display: grid; gap: 12px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        label { font-weight: 600; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        button { padding: 10px 16px; background: #0b4f6c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #9fb3c8; cursor: not-allowed; }
        .status { margin-top: 16px; padding: 12px; border-radius: 6px; }
        .status.success { background: #e9f7ef; color: #2f7d4f; }
        .status.error { background: #fbeaea; color: #9a1e1e; }
    </style>
</head>
<body>
<h1>Crear cuenta</h1>
<p>Completa tus datos y te enviaremos un enlace de verificación.</p>
<form id="signupForm">
    <div>
        <label for="name">Nombre completo</label>
        <input id="name" name="name" required>
    </div>
    <div>
        <label for="email">Correo electrónico</label>
        <input id="email" name="email" type="email" required>
    </div>
    <div>
        <label for="password">Contraseña</label>
        <input id="password" name="password" type="password" minlength="6" required>
    </div>
    <div>
        <label for="nickname">Alias</label>
        <input id="nickname" name="nickname">
    </div>
    <div>
        <label for="rol">Rol</label>
        <input id="rol" name="rol" placeholder="usuario">
    </div>
    <button type="submit">Registrarme</button>
</form>
<div id="status" class="status" hidden></div>
<div id="resend" class="status success" hidden>
    <p id="resendMessage">Correo enviado.</p>
    <button id="resendButton" disabled>Reenviar</button>
    <span id="timer"></span>
</div>

<script>
    const form = document.getElementById('signupForm');
    const statusBox = document.getElementById('status');
    const resendBox = document.getElementById('resend');
    const resendButton = document.getElementById('resendButton');
    const timer = document.getElementById('timer');
    const resendMessage = document.getElementById('resendMessage');
    let lastPayload = null;
    let countdown = null;

    function showStatus(message, type = 'success') {
        statusBox.hidden = false;
        statusBox.textContent = message;
        statusBox.className = `status ${type}`;
    }

    function startTimer(seconds) {
        resendButton.disabled = true;
        timer.textContent = ` (${seconds}s)`;
        countdown = setInterval(() => {
            seconds -= 1;
            timer.textContent = ` (${seconds}s)`;
            if (seconds <= 0) {
                clearInterval(countdown);
                resendButton.disabled = false;
                timer.textContent = '';
            }
        }, 1000);
    }

    async function sendSignup(payload) {
        const response = await fetch('/api/auth/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const contentType = response.headers.get('content-type');
        const isJson = contentType && contentType.includes('application/json');
        const data = isJson ? await response.json() : await response.text();

        if (response.ok) {
            showStatus('Correo enviado. Revisa tu bandeja para verificar tu email.', 'success');
            resendBox.hidden = false;
            resendMessage.textContent = data.expiresAt ? `Correo enviado. El enlace vence el ${data.expiresAt}` : 'Correo enviado.';
            startTimer(30);
            return;
        }

        let message = typeof data === 'string' ? data : (data.message || 'No se pudo procesar la solicitud');
        if (response.status === 400) {
            message = 'El token o el correo no son válidos.';
        } else if (response.status === 409) {
            message = 'Este email ya está verificado. Inicia sesión.';
        } else if (response.status === 410) {
            message = 'El token ha expirado, solicita un reenvío.';
        } else if (response.status === 429) {
            message = 'Demasiadas solicitudes. Espera unos segundos antes de reenviar.';
        }
        showStatus(message, 'error');
    }

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
            name: form.name.value,
            email: form.email.value,
            password: form.password.value,
            nickname: form.nickname.value,
            rol: form.rol.value || 'usuario'
        };
        lastPayload = payload;
        await sendSignup(payload);
    });

    resendButton.addEventListener('click', async () => {
        if (!lastPayload) return;
        clearInterval(countdown);
        await sendSignup(lastPayload);
    });
</script>
</body>
</html>
